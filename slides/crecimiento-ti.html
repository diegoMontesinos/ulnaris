<!-- CRECIMIENTO TI -->
<section id="crecimiento-ti" data-autoslide="0" data-state="crecimiento-ti-state">
	<div class="step-container">

		<!-- TITULO -->
		<div class="ulnaris-title" style="top: 0px; font-size: 50px !important;">
			<span>Crecimiento Mercado de TI</span>
		</div>

		<!-- CONTENIDO -->
		<div class="ulnaris-content">

			<!-- PRIMERA GRAFICA -->
			<div id="crecimiento-ti-data-1" style="left: 590px; top: -35px;">
				<div style="display: none;"><span>Crecimiento 1S14 - 1S15 (MMMXP)</span></div>
			</div>

			<!-- SEGUNDA GRAFICA -->
			<div id="crecimiento-ti-data-2" style="left: 590px; top: -35px;">
			</div>
		</div>
	</div>
</section>

<script type="text/javascript">
	(function () {
		var callbacks = [];

		function graphViz1 () {

			// Dimensions
			var width  = 540,
				height = 580;

			// Escalas
			var x = d3.scale.linear()
			.range([60, 480]);

			var y = d3.scale.ordinal()
			.rangeRoundBands([0, height], .1);

			// Eje
			var yAxis = d3.svg.axis()
			.scale(y)
			.orient("left")
			.tickFormat("");

			// Paleta de colores
			var color = d3.scale.category20();

			// Animate
			var delay = 500, duration = 2000;

			// Chart SVG
			var svg = d3.select("#crecimiento-ti-data-1").append("svg")
			.attr("width", width)
			.attr("height", height);

			// Leemos los datos
			d3.json("data/crecimientoTI1.json", function (error, root) {

				// Datos
				var data   = root.data;
				var values = data.map(function (d) { return parseFloat(d.value); });
				var names  = data.map(function (d) { return d.name; });

				// Dominio
				x.domain([ d3.min(values), d3.max(values) ]);
				y.domain(names);

				// Eje
				svg.append("g")
				.attr("class", "axis")
				.attr("transform", "translate(" + x(0) + ",0)")
				.call(yAxis);

				// Agregamos las barras
				var bar = svg.selectAll(".bar")
				.data(data)
				.enter().append("rect")
				.attr("class", "bar")
				.attr("x", function (d) {
					var x_ = d.value < 0 ? x(0) - 4 : x(0) + 4;
					return x_;
				})
				.attr("y", function (d) { return y(d.name); })
				.attr("width", 0)
				.attr("height", y.rangeBand())
				.style("fill", function (d) {
					return color(d.name);
				});

				// Texto
				var text = svg.selectAll(".text-bar")
				.data(data)
				.enter().append("text")
				.attr("class", "text-bar")
				.attr("dy", "0.9em")
				.attr("y", function (d) { return y(d.name); })
				.attr("x", x(0))
				.text(function (d) {
					return d.value + " %";
				});

				// Labels
				var labels = d3.select("#crecimiento-ti-data-1")
				.selectAll(".label")
				.data(data)
				.enter().append("div")
				.attr("class", "label")
				.style("top", function (d) { return (y(d.name) + 42) + "px"; })
				.html(function (d) { return d.name;	});

				// Cuando se muestra la diapositiva
				callbacks.push(function () {

					// Reseteamos y animamos barras
					bar.attr("x", function (d) {
						var x_ = d.value < 0 ? x(0) - 4 : x(0) + 4;
						return x_;
					})
					.attr("width", 0)
					bar.each(function (d) {
						function offsetX (d) {
							if(d.value < 0)
								return "translate(" + (x(d.value) - x(0)) + ",0)";
							else
								return "translate(0,0)";
						}

						d3.select(this)
						.transition()
						.delay(delay)
						.duration(duration)
						.attr("width", function (d) { return Math.abs(x(d.value) - x(0)); })
						.attr("transform", offsetX);
					});

					// Reseteamos y animamos texto
					text.attr("x", x(0))
					text.each(function (d) {
						function offset (d) {
							var x_ = d.value < 0 ? x(d.value) - 10 : x(d.value) + 10;
							return x_;
						}

						var textAnchor = d.value < 0 ? "end" : "start";
						d3.select(this)
						.style("text-anchor", textAnchor)
						.transition()
						.delay(delay)
						.duration(duration)
						.attr("x", offset);
					});

					$("#crecimiento-ti-data-1 .label").hide();
					$("#crecimiento-ti-data-1").css({ left: "590px" });
					setTimeout(function() {
						$("#crecimiento-ti-data-1 .label").fadeIn(duration);
						setTimeout(function () {
							$("#crecimiento-ti-data-1").animate({
								left: "-=500"
							}, 1000);
						}, delay * 4);
					}, delay);
				});
			});
		}

		function graphViz2 () {
			var svg = ulnaris.D3.buildStackedBar({
				container : "#crecimiento-ti-data-2",
				width     : 900,
				height    : 500,
				margin    : { top: 0, right: 10, bottom: 0, left: 10 },
				jsonPath  : "data/crecimientoTI2.json"
			});
		}

		// Cuando se muestra la diapositiva
		Reveal.addEventListener("crecimiento-ti-state", function() {
			for (var i = 0; i < callbacks.length; i++) {
				callbacks[i]();
			};
		});

		//graphViz1();
		graphViz2();
	})();
</script>;